{% extends "base.html" %}
{% block title %}Order #{{ order.id }} - TaggedByBelle{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="order-detail-container">
  <!-- Page Header -->
  <div class="order-header">
    <h1 class="order-title">Order #{{ order.id }}</h1>
    <p class="order-subtitle">Ordered by {{ order.user.username if order.user else 'Unknown' }}</p>
  </div>
  
  <!-- Order Info Card -->
  <div class="info-card">
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Package</span>
        <span class="info-value">{{ order.package.name if order.package else 'N/A' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Status</span>
        <span class="info-value">
          {% if order.status == 'Active' %}
            <span class="badge badge-active">{{ order.status }}</span>
          {% elif order.status == 'Delivered' %}
            <span class="badge badge-delivered">{{ order.status }}</span>
          {% elif order.status == 'Completed' %}
            <span class="badge badge-completed">{{ order.status }}</span>
          {% elif order.status == 'Late' %}
            <span class="badge badge-late">{{ order.status }}</span>
          {% elif order.status == 'Revision' %}
            <span class="badge badge-revision">{{ order.status }}</span>
          {% elif order.status == 'In dispute' %}
            <span class="badge badge-dispute">{{ order.status }}</span>
          {% elif order.status == 'Cancelled' %}
            <span class="badge badge-cancelled">{{ order.status }}</span>
          {% else %}
            <span class="badge">{{ order.status }}</span>
          {% endif %}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">Due Date</span>
        <span class="info-value">{{ order.due_date.strftime('%b %d, %Y') if order.due_date else 'N/A' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Price</span>
        <span class="info-value" style="color: var(--brand);">${{ order.package.price if order.package else 'N/A' }}</span>
      </div>
    </div>
  </div>
  
  <!-- Requirements Card -->
  <div class="requirements-card">
    <h2 class="requirements-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      Requirements
    </h2>
    
    {% if order.tags %}
    <div class="tags-grid">
      {% for tag in order.tags %}
      <div class="tag-item">
        <span class="tag-name">{{ tag.name }}</span>
        <span class="tag-separator">•</span>
        <span class="tag-mood">{{ tag.mood }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    
    {% if order.details %}
    <div class="order-details-text">{{ order.details }}</div>
    {% endif %}
  </div>
  
  <!-- Timeline -->
  {% if timeline_items %}
  <div class="timeline">
    {% for item_data in timeline_items %}
      {% if item_data.type == 'delivery' %}
        {% set delivery = item_data.delivery %}
        <div class="timeline-item">
          <div class="timeline-icon delivery">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          
          <div class="timeline-content">
            <div class="timeline-header">
              <h3 class="timeline-title">Delivery #{{ delivery.delivery_number }}</h3>
              <span class="timeline-date">{{ delivery.delivered_at.strftime('%b %d, %I:%M %p') if delivery.delivered_at else 'Recently' }}</span>
            </div>
            
            <div class="timeline-message">
              <div class="message-avatar">
                {{ delivery.user.username[0]|upper if delivery.user else 'A' }}
              </div>
              <div class="message-content">
                <div class="message-author">{{ delivery.user.username if delivery.user else 'Admin' }}</div>
                <div class="message-text">{{ delivery.response_text or 'Your order has been delivered.' }}</div>
              </div>
            </div>
            
            {% if delivery.delivery_file %}
            <div class="attachments">
              <div class="attachments-title">Attachments</div>
              <div class="attachment-item">
                <div class="attachment-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                  </svg>
                </div>
                <div class="attachment-info">
                  <div class="attachment-name">{{ delivery.delivery_file }}</div>
                  <div class="attachment-size">File</div>
                </div>
                <a href="/order/{{ order.id }}/download-delivered-file/{{ delivery.id }}" class="download-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Download
                </a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        
      {% elif item_data.type == 'event' %}
        {% set event = item_data.event %}
        <div class="timeline-item">
          <div class="timeline-icon {% if event.event_type == 'revision_requested' %}revision{% elif event.event_type == 'completed' %}completed{% else %}event{% endif %}">
            {% if event.event_type == 'revision_requested' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
            {% elif event.event_type == 'completed' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            {% else %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
            {% endif %}
          </div>
          
          <div class="timeline-content">
            <div class="timeline-header">
              <h3 class="timeline-title">
                {% if event.event_type == 'revision_requested' %}Revision Requested
                {% elif event.event_type == 'cancellation_requested' %}Cancellation Requested
                {% elif event.event_type == 'extension_requested' %}Extension Requested
                {% elif event.event_type == 'request_approved' %}Request Approved
                {% elif event.event_type == 'request_rejected' %}Request Rejected
                {% elif event.event_type == 'completed' %}Order Completed
                {% else %}Order Event
                {% endif %}
              </h3>
              <span class="timeline-date">{{ event.created_at.strftime('%b %d, %I:%M %p') if event.created_at else 'Recently' }}</span>
            </div>
            
            <div class="timeline-message">
              <div class="message-avatar">
                {{ event.user.username[0]|upper if event.user else 'A' }}
              </div>
              <div class="message-content">
                <div class="message-author">{{ event.user.username if event.user else 'Admin' }}</div>
                <div class="message-text">{{ event.event_message or event.cancellation_message or event.extension_reason or 'No message' }}</div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}
  
  <!-- Active Dispute -->
  {% if order.status == 'In dispute' %}
  <div class="info-card" style="border-color: var(--status-dispute);">
    <h2 class="requirements-title" style="color: var(--status-dispute);">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 8v4"></path>
        <path d="M12 16h.01"></path>
      </svg>
      Active Dispute
    </h2>
    
    <div class="timeline-message">
      <div class="message-avatar">
        {{ order.user.username[0]|upper if order.user else 'U' }}
      </div>
      <div class="message-content">
        <div class="message-author">
          {% if order.requested_by_admin == 'true' %}Admin{% else %}{{ order.user.username if order.user else 'User' }}{% endif %}
        </div>
        <div class="message-text">{{ order.request_message or order.cancellation_message or order.extension_reason or 'No message provided' }}</div>
      </div>
    </div>
    
    {% if request.session.get('is_admin') %}
    <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
      <form action="/order/{{ order.id }}/approve-request" method="post" style="flex: 1;">
        <button type="submit" class="btn btn-success" style="width: 100%;">Approve Request</button>
      </form>
      <form action="/order/{{ order.id }}/reject-request" method="post" style="flex: 1;">
        <button type="submit" class="btn btn-danger" style="width: 100%;">Reject Request</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endif %}
  
  <!-- Admin Actions -->
  {% if request.session.get('is_admin') and order.status in ['Active', 'Late', 'Revision'] %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">Deliver Order</h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">Upload files and complete the delivery</p>
      <button onclick="openDeliverModal()" class="btn btn-primary" style="width: 100%;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        {% if order.status == 'Revision' %}Deliver Again{% else %}Deliver Order{% endif %}
      </button>
    </div>
  </div>
  {% endif %}
  
  <!-- User Actions -->
  {% if not request.session.get('is_admin') and order.status == 'Delivered' %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">Mark as Complete</h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">Accept the delivery and complete this order</p>
      <form action="/order/{{ order.id }}/complete" method="post">
        <button type="submit" class="btn btn-success" style="width: 100%;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          Mark Order Complete
        </button>
      </form>
    </div>
  </div>
  {% endif %}
  
  <!-- Support -->
  {% if order.status not in ['Cancelled', 'Completed'] %}
  <div class="info-card">
    <h3 class="requirements-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      Need Help?
    </h3>
    <div style="display: flex; gap: var(--space-4);">
      <a href="/order/{{ order.id }}/resolution" class="btn btn-secondary">
        Resolution Center
      </a>
      <a href="#" class="btn btn-ghost">
        FAQs
      </a>
    </div>
  </div>
  {% endif %}
  
  <!-- Customer Review Section (if order is completed) -->
  {% if order.status == 'Completed' %}
    {% if order.review %}
      <!-- Review Exists - Display It -->
      <div class="review-card-wrapper">
        <div class="review-card-completed">
          <div class="review-header-completed">
            <div class="review-icon-wrapper">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
              </svg>
            </div>
            <div class="review-header-text">
              <h3 class="review-card-title">Your Review</h3>
              <p class="review-card-subtitle">Thank you for your feedback!</p>
            </div>
          </div>
          
          <div class="review-content-display">
            <div class="review-stars-large">
              {% for i in range(5) %}
                <span class="star-display {% if i >= order.review %}star-empty{% endif %}">★</span>
              {% endfor %}
            </div>
            
            <div class="review-info-section">
              <div class="review-meta-display">
                {% if order.user and order.user.avatar %}
                  <img src="{{ url_for('uploads', path=order.user.avatar) }}" alt="{{ order.user.username }}" class="review-avatar-display">
                {% else %}
                  <div class="review-avatar-display">{{ order.user.username[0]|upper if order.user else 'U' }}</div>
                {% endif %}
                
                <div class="review-author-details">
                  <div class="review-author-name">{{ order.user.username if order.user else 'You' }}</div>
                  <div class="review-date">{{ order.completed_date.strftime('%B %d, %Y') if order.completed_date else 'Recently' }}</div>
                </div>
              </div>
              
              {% if order.review_text %}
              <div class="review-text-content">
                <div class="quote-icon">"</div>
                <p class="review-text">{{ order.review_text }}</p>
                <div class="quote-icon-end">"</div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <!-- No Review Yet - Show CTA -->
      {% if not request.session.get('is_admin') %}
      <div class="review-cta-card">
        <div class="review-cta-content">
          <div class="review-cta-icon">⭐</div>
          <div class="review-cta-text">
            <h3 class="review-cta-title">Share Your Experience</h3>
            <p class="review-cta-description">Help others by leaving a review for this completed order</p>
          </div>
          <a href="/order/{{ order.id }}/review" class="btn btn-primary btn-lg">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            Leave a Review
          </a>
        </div>
      </div>
      {% endif %}
    {% endif %}
  {% endif %}
</div>

<style>
/* Review Card for Completed Orders */
.review-card-wrapper {
  margin-top: var(--space-6);
}

.review-card-completed {
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-2xl);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.review-header-completed {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-6);
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
  border-bottom: 1px solid var(--border-subtle);
}

.review-icon-wrapper {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
}

.review-header-text {
  flex: 1;
}

.review-card-title {
  font-size: var(--text-xl);
  font-weight: 800;
  color: var(--text-primary);
  margin: 0 0 var(--space-1) 0;
}

.review-card-subtitle {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  margin: 0;
}

.review-content-display {
  padding: var(--space-8);
}

.review-stars-large {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-bottom: var(--space-8);
}

.star-display {
  color: #fbbf24;
  font-size: 2.5rem;
  filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.3));
}

.star-display.star-empty {
  color: var(--border-default);
  filter: none;
}

.review-info-section {
  max-width: 600px;
  margin: 0 auto;
}

.review-meta-display {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  margin-bottom: var(--space-6);
  padding-bottom: var(--space-6);
  border-bottom: 1px solid var(--border-subtle);
}

.review-avatar-display {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-xl);
  object-fit: cover;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #6d28d9 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 800;
  font-size: var(--text-xl);
  border: 3px solid var(--border-default);
  flex-shrink: 0;
}

.review-author-details {
  flex: 1;
}

.review-author-name {
  font-size: var(--text-lg);
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.review-date {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.review-text-content {
  position: relative;
  padding: var(--space-6);
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  border-left: 4px solid #fbbf24;
}

.quote-icon {
  position: absolute;
  top: var(--space-4);
  left: var(--space-4);
  font-size: 3rem;
  color: rgba(251, 191, 36, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
}

.quote-icon-end {
  position: absolute;
  bottom: var(--space-2);
  right: var(--space-4);
  font-size: 3rem;
  color: rgba(251, 191, 36, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
  transform: rotate(180deg);
}

.review-text {
  font-size: var(--text-base);
  color: var(--text-secondary);
  line-height: var(--leading-relaxed);
  font-style: italic;
  padding: var(--space-4) var(--space-8);
  margin: 0;
}

/* Review CTA for Completed Orders Without Review */
.review-cta-card {
  background: linear-gradient(135deg, var(--surface) 0%, var(--bg-tertiary) 100%);
  border: 2px dashed var(--border-default);
  border-radius: var(--radius-2xl);
  padding: var(--space-10);
  margin-top: var(--space-6);
  transition: all var(--transition-base);
}

.review-cta-card:hover {
  border-color: #fbbf24;
  background: linear-gradient(135deg, var(--surface-hover) 0%, var(--bg-elevated) 100%);
  box-shadow: 0 0 30px rgba(251, 191, 36, 0.15);
}

.review-cta-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: var(--space-4);
}

.review-cta-icon {
  font-size: 4rem;
  animation: pulse-star 2s ease-in-out infinite;
}

@keyframes pulse-star {
  0%, 100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.3));
  }
  50% {
    transform: scale(1.1);
    filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.6));
  }
}

.review-cta-text {
  max-width: 500px;
}

.review-cta-title {
  font-size: var(--text-2xl);
  font-weight: 900;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.review-cta-description {
  font-size: var(--text-base);
  color: var(--text-secondary);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-6);
}

/* Responsive */
@media (max-width: 768px) {
  .review-content-display {
    padding: var(--space-6);
  }
  
  .review-stars-large {
    gap: 4px;
  }
  
  .star-display {
    font-size: 2rem;
  }
  
  .review-cta-card {
    padding: var(--space-6);
  }
  
  .review-cta-icon {
    font-size: 3rem;
  }
  
  .review-cta-title {
    font-size: var(--text-xl);
  }
  
  .quote-icon,
  .quote-icon-end {
    font-size: 2rem;
  }
}
</style>

<!-- Deliver Modal -->
<div id="deliverModal" class="delivery-modal">
  <div class="modal-backdrop" onclick="closeDeliverModal()"></div>
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-header-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
      </div>
      <div class="modal-header-text">
        <h2 class="modal-title">Deliver Order #{{ order.id }}</h2>
        <p class="modal-subtitle">Upload files and complete the delivery</p>
      </div>
      <button onclick="closeDeliverModal()" class="modal-close" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <form action="/order/{{ order.id }}/deliver" method="post" enctype="multipart/form-data" id="deliverForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="response_text" class="form-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Delivery Message
          </label>
          <textarea 
            id="response_text" 
            name="response_text" 
            class="form-textarea" 
            rows="5" 
            placeholder="Describe what you've delivered, any notes, or instructions for the customer..."
            required
          ></textarea>
          <span class="form-help">Be clear and professional in your delivery message</span>
        </div>
        
        <div class="form-group">
          <label for="file" class="form-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
            Upload Delivery File
          </label>
          
          <div class="file-upload-area" id="fileUploadArea">
            <input 
              type="file" 
              id="file" 
              name="file" 
              class="file-input" 
              accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.zip,.rar,.wav,.mp3"
              required
              onchange="handleFileSelect(this)"
            >
            <label for="file" class="file-upload-label">
              <div class="file-upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </div>
              <div class="file-upload-text">
                <span class="file-upload-title">Click to upload or drag and drop</span>
                <span class="file-upload-subtitle">PDF, DOC, Images, Audio, ZIP (max 10MB)</span>
              </div>
            </label>
            <div class="file-selected" id="fileSelected" style="display: none;">
              <div class="file-selected-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                  <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
              </div>
              <div class="file-selected-info">
                <div class="file-selected-name" id="fileName"></div>
                <div class="file-selected-size" id="fileSize"></div>
              </div>
              <button type="button" onclick="clearFile()" class="file-remove-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" onclick="closeDeliverModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-success" id="submitDeliveryBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          Deliver Order
        </button>
      </div>
    </form>
  </div>
</div>

<style>
/* Enhanced Delivery Modal */
.delivery-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: var(--z-modal);
  align-items: center;
  justify-content: center;
  padding: var(--space-6);
}

.delivery-modal.is-open {
  display: flex;
}

.modal-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(10, 14, 23, 0.85);
  backdrop-filter: blur(8px);
  animation: fadeIn 0.2s ease-out;
}

.modal-panel {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-2xl);
  max-width: 650px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-2xl);
  animation: slideUp 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  display: flex;
  align-items: flex-start;
  gap: var(--space-4);
  padding: var(--space-8);
  border-bottom: 1px solid var(--border-subtle);
}

.modal-header-icon {
  width: 48px;
  height: 48px;
  background: var(--brand-subtle);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
  flex-shrink: 0;
}

.modal-header-text {
  flex: 1;
}

.modal-title {
  font-size: var(--text-2xl);
  font-weight: 900;
  margin-bottom: var(--space-1);
  color: var(--text-primary);
}

.modal-subtitle {
  font-size: var(--text-sm);
  color: var(--text-secondary);
}

.modal-close {
  width: 36px;
  height: 36px;
  background: transparent;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
  flex-shrink: 0;
}

.modal-close:hover {
  background: var(--surface-hover);
  border-color: var(--border-strong);
  color: var(--text-primary);
}

.modal-body {
  padding: var(--space-8);
}

.modal-footer {
  display: flex;
  gap: var(--space-4);
  justify-content: flex-end;
  padding: var(--space-6) var(--space-8);
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-secondary);
}

/* File Upload Area */
.file-upload-area {
  position: relative;
}

.file-input {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.file-upload-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-8);
  background: var(--bg-secondary);
  border: 2px dashed var(--border-default);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all var(--transition-base);
}

.file-upload-label:hover {
  border-color: var(--brand);
  background: var(--bg-tertiary);
}

.file-upload-icon {
  color: var(--text-tertiary);
  transition: all var(--transition-base);
}

.file-upload-label:hover .file-upload-icon {
  color: var(--brand);
  transform: translateY(-4px);
}

.file-upload-text {
  text-align: center;
}

.file-upload-title {
  display: block;
  font-size: var(--text-base);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.file-upload-subtitle {
  display: block;
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.file-selected {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4);
  background: var(--success-bg);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: var(--radius-lg);
}

.file-selected-icon {
  width: 40px;
  height: 40px;
  background: var(--success);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

.file-selected-info {
  flex: 1;
  min-width: 0;
}

.file-selected-name {
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: var(--space-1);
}

.file-selected-size {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.file-remove-btn {
  width: 32px;
  height: 32px;
  background: transparent;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.file-remove-btn:hover {
  background: var(--error-bg);
  border-color: var(--error);
  color: var(--error);
}

@media (max-width: 768px) {
  .modal-panel {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .modal-header {
    padding: var(--space-6);
  }
  
  .modal-body {
    padding: var(--space-6);
  }
  
  .modal-footer {
    padding: var(--space-4) var(--space-6);
    flex-direction: column;
  }
  
  .modal-footer .btn {
    width: 100%;
  }
}
</style>

<script>
function openDeliverModal() {
  document.getElementById('deliverModal').classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeDeliverModal() {
  document.getElementById('deliverModal').classList.remove('is-open');
  document.body.style.overflow = '';
  document.getElementById('deliverForm').reset();
  document.getElementById('fileUploadArea').querySelector('.file-upload-label').style.display = 'flex';
  document.getElementById('fileSelected').style.display = 'none';
}

function handleFileSelect(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const fileLabel = document.getElementById('fileUploadArea').querySelector('.file-upload-label');
    const fileSelected = document.getElementById('fileSelected');
    
    // Hide upload label, show selected file
    fileLabel.style.display = 'none';
    fileSelected.style.display = 'flex';
    
    // Update file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
  }
}

function clearFile() {
  const fileInput = document.getElementById('file');
  fileInput.value = '';
  document.getElementById('fileUploadArea').querySelector('.file-upload-label').style.display = 'flex';
  document.getElementById('fileSelected').style.display = 'none';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('deliverModal').classList.contains('is-open')) {
    closeDeliverModal();
  }
});

// Form submission with loading state
document.getElementById('deliverForm').addEventListener('submit', function(e) {
  const submitBtn = document.getElementById('submitDeliveryBtn');
  const originalHTML = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
  
  // Re-enable after 10 seconds in case of error
  setTimeout(() => {
    if (submitBtn.disabled) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalHTML;
    }
  }, 10000);
});
</script>
{% endblock %}

