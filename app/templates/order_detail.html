{% extends "base.html" %}
{% block title %}Order #{{ order.id }} - TaggedByBelle{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="order-detail-wrapper">
  <div class="order-detail-layout">
    <!-- Main Content -->
    <div class="order-main-content">
      <!-- Page Header -->
      <div class="order-header">
        <h1 class="order-title">Order #{{ order.id }}</h1>
      </div>
      
      <!-- Order Started Event Card -->
      <div class="order-started-card">
        <div class="order-started-accent"></div>
        <div class="order-started-content">
          <div class="order-started-title">Order started</div>
          <div class="order-started-message">
            {% if request.session.get('is_admin') %}
              {{ order.user.username if order.user else 'User' }} sent all the information you need so you can start working on this order. You got this!
            {% else %}
              You sent all the information we need so we can start working on this order. You got this!
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Requirements Card -->
      <div class="requirements-card">
        <h2 class="requirements-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          Requirements
        </h2>
        
        {% if order.tags %}
        <div class="tags-grid">
          {% for tag in order.tags %}
          <div class="tag-item">
            <span class="tag-name">{{ tag.name }}</span>
            <span class="tag-separator">‚Ä¢</span>
            <span class="tag-mood">{{ tag.mood }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {% if order.details %}
        <div class="order-details-text">{{ order.details }}</div>
        {% endif %}
      </div>
      
      <!-- Timeline -->
      {% if timeline_items %}
      <div class="timeline">
    {% for item_data in timeline_items %}
      {% if item_data.type == 'delivery' %}
        {% set delivery = item_data.delivery %}
        <div class="timeline-item">
          <div class="timeline-icon delivery">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          
          <div class="timeline-content">
            <div class="timeline-header">
              <h3 class="timeline-title">Delivery #{{ delivery.delivery_number }}</h3>
              <span class="timeline-date">{{ delivery.delivered_at.strftime('%b %d, %I:%M %p') if delivery.delivered_at else 'Recently' }}</span>
            </div>
            
            <div class="timeline-message">
              <div class="message-avatar">
                {% if delivery.user and delivery.user.avatar %}
                  <img src="{{ url_for('uploads', path=delivery.user.avatar) }}" alt="{{ delivery.user.username }}">
                {% else %}
                  <div class="avatar-placeholder">{{ delivery.user.username[0]|upper if delivery.user else 'A' }}</div>
                {% endif %}
              </div>
              <div class="message-content">
                <div class="message-author">{{ delivery.user.username if delivery.user else 'Admin' }}</div>
                <div class="message-text">{{ delivery.response_text or 'Your order has been delivered.' }}</div>
              </div>
            </div>
            
            {% set delivery_files = delivery.files if delivery.files else ([(delivery.delivery_file)] if delivery.delivery_file else []) %}
            {% if delivery_files %}
            <div class="attachments">
              <div class="attachments-title">Attachments</div>
              {% for file_item in delivery_files %}
                {% set filename = file_item.filename if file_item.filename else file_item %}
                {% set original_filename = file_item.original_filename if file_item.original_filename else file_item %}
                {% set file_id = file_item.id if file_item.id else delivery.id %}
                {% set filename_lower = filename.lower() %}
                {% set is_audio = filename_lower.endswith('.wav') or filename_lower.endswith('.mp3') or filename_lower.endswith('.ogg') or filename_lower.endswith('.flac') or filename_lower.endswith('.m4a') %}
                <div class="attachment-item">
                  <div class="attachment-icon">
                    {% if is_audio %}
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                      </svg>
                    {% else %}
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                      </svg>
                    {% endif %}
                  </div>
                  <div class="attachment-info">
                    <div class="attachment-name">{{ original_filename if original_filename else filename }}</div>
                    <div class="attachment-size">
                      {% if file_item.file_size %}
                        {% set size_mb = file_item.file_size / (1024 * 1024) %}
                        {{ "%.1f MB"|format(size_mb) if size_mb >= 1 else "%.0f KB"|format(file_item.file_size / 1024) }}
                      {% else %}
                        File
                      {% endif %}
                    </div>
                  </div>
                  <div class="attachment-actions">
                    {% if is_audio %}
                      <button onclick="openAudioPreview('{{ url_for('uploads', path=filename) }}', '{{ original_filename if original_filename else filename }}')" class="preview-btn" title="Preview">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Preview
                      </button>
                    {% endif %}
                    <a href="/order/{{ order.id }}/download-delivered-file/{{ file_id }}" class="download-btn">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                      </svg>
                      Download
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        
      {% elif item_data.type == 'event' %}
        {% set event = item_data.event %}
        <div class="timeline-item">
          <div class="timeline-icon {% if event.event_type == 'revision_requested' %}revision{% elif event.event_type == 'completed' %}completed{% elif event.event_type == 'cancellation_approved' %}completed{% elif event.event_type == 'delivery_date_updated' %}delivery-date{% elif event.event_type == 'extension_requested' %}extension{% else %}event{% endif %}">
            {% if event.event_type == 'revision_requested' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
            {% elif event.event_type == 'extension_requested' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            {% elif event.event_type == 'request_approved' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            {% elif event.event_type == 'completed' or event.event_type == 'cancellation_approved' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            {% elif event.event_type == 'delivery_date_updated' %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            {% else %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
            {% endif %}
          </div>
          
          <div class="timeline-content">
            <div class="timeline-header">
              <h3 class="timeline-title">
                {% if event.event_type == 'revision_requested' %}Revision Requested
                {% elif event.event_type == 'cancellation_requested' %}Cancellation Requested
                {% elif event.event_type == 'cancellation_approved' %}Cancellation Approved
                {% elif event.event_type == 'extension_requested' %}Extension Requested
                {% elif event.event_type == 'request_approved' %}Request Approved
                {% elif event.event_type == 'request_rejected' %}Request Rejected
                {% elif event.event_type == 'completed' %}Order Completed
                {% elif event.event_type == 'delivery_date_updated' %}Delivery Date Updated
                {% else %}Order Event
                {% endif %}
              </h3>
              <span class="timeline-date">{{ event.created_at.strftime('%b %d, %I:%M %p') if event.created_at else 'Recently' }}</span>
            </div>
            
            <div class="timeline-message">
              <div class="message-avatar">
                {% if event.user and event.user.avatar %}
                  <img src="{{ url_for('uploads', path=event.user.avatar) }}" alt="{{ event.user.username }}">
                {% else %}
                  <div class="avatar-placeholder">{{ event.user.username[0]|upper if event.user else 'A' }}</div>
                {% endif %}
              </div>
              <div class="message-content">
                <div class="message-author">{{ event.user.username if event.user else 'Admin' }}</div>
                {% if event.event_type == 'request_approved' and not request.session.get('is_admin') %}
                  {# For request_approved events, non-admin users only see the username, no message #}
                {% else %}
                  <div class="message-text">{{ event.event_message or event.cancellation_message or event.extension_reason or 'No message' }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}
  
  <!-- Admin Actions -->
  {% if request.session.get('is_admin') and order.status in ['Active', 'Late', 'Revision'] %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">Deliver Order</h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">Upload files and complete the delivery</p>
      <button onclick="openDeliverModal()" class="btn btn-primary" style="width: 100%;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        {% if order.status == 'Revision' %}Deliver Again{% else %}Deliver Order{% endif %}
      </button>
    </div>
  </div>
  {% endif %}
  
  <!-- Admin Actions: Approve/Reject User Requests -->
  {% if request.session.get('is_admin') and order.status == 'In dispute' and order.requested_by_admin != 'true' %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">
        {% if order.request_type == 'extend_delivery' %}
          Extension Request from {{ order.user.username if order.user else 'User' }}
        {% elif order.request_type == 'cancellation' %}
          Cancellation Request from {{ order.user.username if order.user else 'User' }}
        {% elif order.request_type == 'revision' %}
          Revision Request from {{ order.user.username if order.user else 'User' }}
        {% else %}
          Request from {{ order.user.username if order.user else 'User' }}
        {% endif %}
      </h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
        {% if order.request_type == 'extend_delivery' %}
          {{ order.user.username if order.user else 'User' }} requested a {{ order.extension_days }}-day extension. {{ order.extension_reason or 'No reason provided.' }}
        {% elif order.request_type == 'cancellation' %}
          {{ order.user.username if order.user else 'User' }} requested cancellation: {{ order.cancellation_message or order.cancellation_reason or 'No reason provided.' }}
        {% elif order.request_type == 'revision' %}
          {{ order.user.username if order.user else 'User' }} requested a revision: {{ order.request_message or 'No message provided.' }}
        {% else %}
          {{ order.request_message or 'No message provided.' }}
        {% endif %}
      </p>
      <div style="display: flex; gap: var(--space-4);">
        <form action="/order/{{ order.id }}/approve-request" method="post" style="flex: 1;">
          <button type="submit" class="btn btn-success" style="width: 100%;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Approve Request
          </button>
        </form>
        <form action="/order/{{ order.id }}/reject-request" method="post" style="flex: 1;">
          <button type="submit" class="btn btn-danger" style="width: 100%;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Decline Request
          </button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- User Actions: Approve/Reject Admin Requests -->
  {% if not request.session.get('is_admin') and order.status == 'In dispute' and order.requested_by_admin == 'true' %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">
        {% if order.request_type == 'extend_delivery' %}
          Extension Request from Admin
        {% elif order.request_type == 'cancellation' %}
          Cancellation Request from Admin
        {% else %}
          Request from Admin
        {% endif %}
      </h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
        {% if order.request_type == 'extend_delivery' %}
          Admin requested a {{ order.extension_days }}-day extension. {{ order.extension_reason or 'No reason provided.' }}
        {% elif order.request_type == 'cancellation' %}
          Admin requested cancellation: {{ order.cancellation_message or order.cancellation_reason or 'No reason provided.' }}
        {% else %}
          {{ order.request_message or 'No message provided.' }}
        {% endif %}
      </p>
      <div style="display: flex; gap: var(--space-4);">
        <form action="/order/{{ order.id }}/approve-request" method="post" style="flex: 1;">
          <button type="submit" class="btn btn-success" style="width: 100%;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Approve Request
          </button>
        </form>
        <form action="/order/{{ order.id }}/reject-request" method="post" style="flex: 1;">
          <button type="submit" class="btn btn-danger" style="width: 100%;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Reject Request
          </button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- User Actions: Mark as Complete -->
  {% if not request.session.get('is_admin') and order.status == 'Delivered' %}
  <div class="order-actions">
    <div class="action-card">
      <h3 class="action-title">Mark as Complete</h3>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">Accept the delivery and complete this order</p>
      <form action="/order/{{ order.id }}/complete" method="post">
        <button type="submit" class="btn btn-success" style="width: 100%;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          Mark Order Complete
        </button>
      </form>
    </div>
  </div>
  {% endif %}
  
  
  <!-- Customer Review Section (if order is completed) -->
  {% if order.status == 'Completed' %}
    {% if order.review %}
      <!-- Review Exists - Display It -->
      <div class="review-card-wrapper">
        <div class="review-card-completed">
          <div class="review-header-completed">
            <div class="review-icon-wrapper">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
              </svg>
            </div>
            <div class="review-header-text">
              <h3 class="review-card-title">Your Review</h3>
              <p class="review-card-subtitle">Thank you for your feedback!</p>
            </div>
          </div>
          
          <div class="review-content-display">
            <div class="review-stars-large">
              {% for i in range(5) %}
                <span class="star-display {% if i >= order.review %}star-empty{% endif %}">‚òÖ</span>
              {% endfor %}
            </div>
            
            <div class="review-info-section">
              <div class="review-meta-display">
                {% if order.user and order.user.avatar %}
                  <img src="{{ url_for('uploads', path=order.user.avatar) }}" alt="{{ order.user.username }}" class="review-avatar-display">
                {% else %}
                  <div class="review-avatar-display">{{ order.user.username[0]|upper if order.user else 'U' }}</div>
                {% endif %}
                
                <div class="review-author-details">
                  <div class="review-author-name">{{ order.user.username if order.user else 'You' }}</div>
                  <div class="review-date">{{ order.completed_date.strftime('%B %d, %Y') if order.completed_date else 'Recently' }}</div>
                </div>
              </div>
              
              {% if order.review_text %}
              <div class="review-text-content">
                <div class="quote-icon">"</div>
                <p class="review-text">{{ order.review_text }}</p>
                <div class="quote-icon-end">"</div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <!-- No Review Yet - Show CTA -->
      {% if not request.session.get('is_admin') %}
      <div class="review-cta-card">
        <div class="review-cta-content">
          <div class="review-cta-icon">‚≠ê</div>
          <div class="review-cta-text">
            <h3 class="review-cta-title">Share Your Experience</h3>
            <p class="review-cta-description">Help others by leaving a review for this completed order</p>
          </div>
          <a href="/order/{{ order.id }}/review" class="btn btn-primary btn-lg">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            Leave a Review
          </a>
        </div>
      </div>
      {% endif %}
    {% endif %}
  {% endif %}
    </div>
    
    <!-- Sidebar -->
    <div class="order-sidebar">
      <!-- Order Details -->
      <div class="sidebar-section">
        <h2 class="sidebar-title">Order details</h2>
        
        <!-- Service Description -->
        <div class="service-preview">
          <div class="service-thumbnail">
            {% if order.package and order.package.name %}
              <div class="thumbnail-placeholder">{{ order.package.name[0]|upper }}</div>
            {% else %}
              <div class="thumbnail-placeholder">O</div>
            {% endif %}
          </div>
          <div class="service-info">
            <p class="service-description">
              {{ order.package.name if order.package else 'Package' }} - {{ order.package.description if order.package and order.package.description else 'Audio tagging service' }}
            </p>
            <span class="status-badge status-{{ order.status|lower|replace(' ', '-') }}">
              {{ order.status.upper() }}
            </span>
          </div>
        </div>
      </div>
      
      <!-- Time Left to Deliver -->
      {% if order.status != 'Completed' and order.status != 'Cancelled' and order.status != 'Delivered' and order.due_date %}
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">Time left to deliver</h3>
        <div class="countdown-timer" id="countdownTimer">
          <div class="countdown-item">
            <span class="countdown-value" id="days">00</span>
            <span class="countdown-label">Days</span>
          </div>
          <div class="countdown-separator">:</div>
          <div class="countdown-item">
            <span class="countdown-value" id="hours">00</span>
            <span class="countdown-label">Hours</span>
          </div>
          <div class="countdown-separator">:</div>
          <div class="countdown-item">
            <span class="countdown-value" id="minutes">00</span>
            <span class="countdown-label">Minutes</span>
          </div>
          <div class="countdown-separator">:</div>
          <div class="countdown-item">
            <span class="countdown-value" id="seconds">00</span>
            <span class="countdown-label">Seconds</span>
          </div>
        </div>
        {% if not request.session.get('is_admin') %}
        <a href="/resolution-center/{{ order.id }}" class="extend-link">Extend delivery date</a>
        {% endif %}
        {% if request.session.get('is_admin') and order.status == 'Active' %}
        <button onclick="openDeliverModal()" class="btn-deliver-now">Deliver now</button>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- Deliver Again Card (for Delivered orders) -->
      {% if order.status == 'Delivered' and request.session.get('is_admin') %}
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">Want to deliver again?</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">You can deliver additional files or updates for this order.</p>
        <button onclick="openDeliverModal()" class="btn btn-primary" style="width: 100%;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          Deliver Again
        </button>
      </div>
      {% endif %}
      
      <!-- Seller/Buyer Information -->
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">{% if request.session.get('is_admin') %}Buyer{% else %}Seller{% endif %} Information</h3>
        <div class="user-info">
          <div class="user-avatar-wrapper">
            {% if request.session.get('is_admin') %}
              <!-- Admin viewing: Show buyer (order user) -->
              {% if order.user and order.user.avatar %}
                <img src="{{ url_for('uploads', path=order.user.avatar) }}" alt="{{ order.user.username }}" class="user-avatar">
              {% else %}
                <div class="user-avatar-placeholder">{{ order.user.username[0]|upper if order.user else 'U' }}</div>
              {% endif %}
            {% else %}
              <!-- User viewing: Show seller (admin) -->
              {% if admin_user %}
                {% if admin_user.avatar %}
                  <img src="{{ url_for('uploads', path=admin_user.avatar) }}" alt="{{ admin_user.username }}" class="user-avatar">
                {% else %}
                  <div class="user-avatar-placeholder">{{ admin_user.username[0]|upper }}</div>
                {% endif %}
              {% else %}
                <div class="user-avatar-placeholder">A</div>
              {% endif %}
            {% endif %}
            <div class="online-indicator"></div>
          </div>
          <div class="user-details">
            {% if request.session.get('is_admin') %}
              <!-- Admin viewing: Show buyer info -->
              <div class="user-name">{{ order.user.username if order.user else 'User' }}</div>
              <div class="user-handle">@{{ order.user.username if order.user else 'user' }}</div>
            {% else %}
              <!-- User viewing: Show seller (admin) info -->
              {% if admin_user %}
                <div class="user-name">{{ admin_user.username }}</div>
                <div class="user-handle">@{{ admin_user.username.lower() }}</div>
              {% else %}
                <div class="user-name">Admin</div>
                <div class="user-handle">@admin</div>
              {% endif %}
            {% endif %}
            <div class="user-status">Last seen recently</div>
          </div>
        </div>
        <button class="btn-message-user" onclick="toggleChatSidebar()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          Message {% if request.session.get('is_admin') %}{{ order.user.username if order.user else 'User' }}{% else %}{{ admin_user.username if admin_user else 'Admin' }}{% endif %}
        </button>
      </div>
      
      <!-- Order Summary -->
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">Order Summary</h3>
        <div class="order-summary-list">
          <div class="summary-item">
            <span class="summary-label">Ordered by</span>
            <span class="summary-value">{{ order.user.username if order.user else 'Unknown' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Delivery date</span>
            <span class="summary-value">{{ order.due_date.strftime('%b %d, %I:%M %p') if order.due_date else 'N/A' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total price</span>
            <span class="summary-value" style="color: var(--brand);">${{ order.package.price if order.package else 'N/A' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Order number</span>
            <span class="summary-value">#{{ order.id }}</span>
          </div>
        </div>
      </div>
      
      <!-- Track Order -->
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">
          Track Order
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </h3>
        <div class="track-order">
          <div class="track-step track-step-completed">
            <div class="track-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <span class="track-label">Requirements submitted</span>
          </div>
          <div class="track-step {% if order.status == 'Active' or order.status == 'Revision' or order.status == 'Delivered' or order.status == 'Completed' %}track-step-completed{% endif %}">
            <div class="track-icon">
              {% if order.status == 'Active' or order.status == 'Revision' or order.status == 'Delivered' or order.status == 'Completed' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                </svg>
              {% else %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                </svg>
              {% endif %}
            </div>
            <span class="track-label">Order in progress</span>
          </div>
          {% if order.status == 'Delivered' or order.status == 'Completed' %}
          <div class="track-step track-step-completed">
            <div class="track-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <span class="track-label">Order delivered</span>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Help & Support -->
      {% if order.status not in ['Cancelled', 'Completed'] %}
      <div class="sidebar-section">
        <h3 class="sidebar-subtitle">Help & Support</h3>
        <div class="support-actions">
          <a href="/order/{{ order.id }}/resolution" class="support-item">
            <div class="support-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <path d="M12 17h.01"></path>
              </svg>
            </div>
            <div class="support-content">
              <div class="support-title">Resolution Center</div>
              <div class="support-description">Request changes or help</div>
            </div>
          </a>
          
          <a href="#" class="support-item">
            <div class="support-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <path d="M12 17h.01"></path>
              </svg>
            </div>
            <div class="support-content">
              <div class="support-title">FAQs</div>
              <div class="support-description">Common questions</div>
            </div>
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Chat Sidebar (Hidden by default) -->
  <div class="chat-sidebar" id="chatSidebar">
    <div class="chat-sidebar-header">
      <h3 class="chat-sidebar-title">Messages</h3>
      <button class="chat-sidebar-close" onclick="toggleChatSidebar()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      {% if messages %}
        {% for message in messages %}
        <div class="message {% if message.sender_id == request.session.get('user_id') %}message-sent{% else %}message-received{% endif %}">
          <div class="message-avatar">
            {% if message.sender and message.sender.avatar %}
              <img src="{{ url_for('uploads', path=message.sender.avatar) }}" alt="{{ message.sender.username }}">
            {% else %}
              <div class="avatar-placeholder">{{ message.sender.username[0]|upper if message.sender else 'U' }}</div>
            {% endif %}
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-author">{{ message.sender.username if message.sender else 'User' }}</span>
              <span class="message-time">{{ message.created_at.strftime('%b %d, %I:%M %p') if message.created_at else 'Now' }}</span>
            </div>
            <div class="message-bubble">
              <p class="message-text">{{ message.message_text }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="chat-empty">
          <div class="chat-empty-icon">üí¨</div>
          <p class="chat-empty-text">No messages yet. Start the conversation!</p>
        </div>
      {% endif %}
    </div>
    
    <form action="/order/{{ order.id }}/messages/send" method="post" class="chat-input-form" id="chatForm">
      <div class="chat-input-wrapper">
        <textarea 
          name="message_text" 
          id="messageInput"
          class="chat-input" 
          placeholder="Type your message..."
          rows="1"
          required
        ></textarea>
        <button type="submit" class="chat-send-btn" id="sendBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </form>
  </div>
  
  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleChatSidebar()"></div>
</div>

<style>
/* Review Card for Completed Orders */
.review-card-wrapper {
  margin-top: var(--space-6);
}

.review-card-completed {
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-2xl);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.review-header-completed {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-6);
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
  border-bottom: 1px solid var(--border-subtle);
}

.review-icon-wrapper {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
}

.review-header-text {
  flex: 1;
}

.review-card-title {
  font-size: var(--text-xl);
  font-weight: 800;
  color: var(--text-primary);
  margin: 0 0 var(--space-1) 0;
}

.review-card-subtitle {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  margin: 0;
}

.review-content-display {
  padding: var(--space-8);
}

.review-stars-large {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-bottom: var(--space-8);
}

.star-display {
  color: #fbbf24;
  font-size: 2.5rem;
  filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.3));
}

.star-display.star-empty {
  color: var(--border-default);
  filter: none;
}

.review-info-section {
  max-width: 600px;
  margin: 0 auto;
}

.review-meta-display {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  margin-bottom: var(--space-6);
  padding-bottom: var(--space-6);
  border-bottom: 1px solid var(--border-subtle);
}

.review-avatar-display {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-xl);
  object-fit: cover;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #6d28d9 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 800;
  font-size: var(--text-xl);
  border: 3px solid var(--border-default);
  flex-shrink: 0;
}

.review-author-details {
  flex: 1;
}

.review-author-name {
  font-size: var(--text-lg);
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.review-date {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.review-text-content {
  position: relative;
  padding: var(--space-6);
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  border-left: 4px solid #fbbf24;
}

.quote-icon {
  position: absolute;
  top: var(--space-4);
  left: var(--space-4);
  font-size: 3rem;
  color: rgba(251, 191, 36, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
}

.quote-icon-end {
  position: absolute;
  bottom: var(--space-2);
  right: var(--space-4);
  font-size: 3rem;
  color: rgba(251, 191, 36, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
  transform: rotate(180deg);
}

.review-text {
  font-size: var(--text-base);
  color: var(--text-secondary);
  line-height: var(--leading-relaxed);
  font-style: italic;
  padding: var(--space-4) var(--space-8);
  margin: 0;
}

/* Review CTA for Completed Orders Without Review */
.review-cta-card {
  background: linear-gradient(135deg, var(--surface) 0%, var(--bg-tertiary) 100%);
  border: 2px dashed var(--border-default);
  border-radius: var(--radius-2xl);
  padding: var(--space-10);
  margin-top: var(--space-6);
  transition: all var(--transition-base);
}

.review-cta-card:hover {
  border-color: #fbbf24;
  background: linear-gradient(135deg, var(--surface-hover) 0%, var(--bg-elevated) 100%);
  box-shadow: 0 0 30px rgba(251, 191, 36, 0.15);
}

.review-cta-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: var(--space-4);
}

.review-cta-icon {
  font-size: 4rem;
  animation: pulse-star 2s ease-in-out infinite;
}

@keyframes pulse-star {
  0%, 100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.3));
  }
  50% {
    transform: scale(1.1);
    filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.6));
  }
}

.review-cta-text {
  max-width: 500px;
}

.review-cta-title {
  font-size: var(--text-2xl);
  font-weight: 900;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.review-cta-description {
  font-size: var(--text-base);
  color: var(--text-secondary);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-6);
}

/* Responsive */
@media (max-width: 768px) {
  .review-content-display {
    padding: var(--space-6);
  }
  
  .review-stars-large {
    gap: 4px;
  }
  
  .star-display {
    font-size: 2rem;
  }
  
  .review-cta-card {
    padding: var(--space-6);
  }
  
  .review-cta-icon {
    font-size: 3rem;
  }
  
  .review-cta-title {
    font-size: var(--text-xl);
  }
  
  .quote-icon,
  .quote-icon-end {
    font-size: 2rem;
  }
}

/* Chat Section */
.chat-section {
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-2xl);
  margin-top: var(--space-8);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.chat-header {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-6);
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border-bottom: 1px solid var(--border-subtle);
}

.chat-header-icon {
  width: 48px;
  height: 48px;
  background: var(--brand-subtle);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
  flex-shrink: 0;
}

.chat-title {
  font-size: var(--text-xl);
  font-weight: 800;
  color: var(--text-primary);
  margin: 0 0 var(--space-1) 0;
}

.chat-subtitle {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  margin: 0;
}

.chat-messages {
  padding: var(--space-6);
  max-height: 500px;
  overflow-y: auto;
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.chat-messages::-webkit-scrollbar {
  width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--border-default);
  border-radius: var(--radius-md);
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: var(--border-strong);
}

.message {
  display: flex;
  gap: var(--space-3);
}

.message-sent {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  flex-shrink: 0;
}

.message-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.message-avatar .avatar-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #6d28d9 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: var(--text-sm);
}

.message-sent .message-avatar .avatar-placeholder {
  background: linear-gradient(135deg, var(--brand) 0%, #b8d633 100%);
  color: var(--text-inverse);
}

.message-content {
  flex: 1;
  min-width: 0;
  max-width: 70%;
}

.message-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  margin-bottom: var(--space-1);
  font-size: var(--text-xs);
}

.message-sent .message-header {
  flex-direction: row-reverse;
}

.message-author {
  font-weight: 700;
  color: var(--text-primary);
}

.message-time {
  color: var(--text-tertiary);
}

.message-bubble {
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-lg);
  background: var(--surface);
  border: 1px solid var(--border-subtle);
}

.message-sent .message-bubble {
  background: linear-gradient(135deg, var(--brand) 0%, #b8d633 100%);
  color: var(--text-inverse);
  border-color: var(--brand);
}

.message-text {
  margin: 0;
  font-size: var(--text-sm);
  line-height: var(--leading-relaxed);
  word-wrap: break-word;
}

.message-sent .message-text {
  color: var(--text-inverse);
}

.chat-empty {
  text-align: center;
  padding: var(--space-12);
}

.chat-empty-icon {
  font-size: 3rem;
  margin-bottom: var(--space-4);
  opacity: 0.5;
}

.chat-empty-text {
  color: var(--text-tertiary);
  font-size: var(--text-sm);
}

.chat-input-form {
  padding: var(--space-4);
  background: var(--surface);
  border-top: 1px solid var(--border-subtle);
}

.chat-input-wrapper {
  display: flex;
  gap: var(--space-3);
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: var(--space-3) var(--space-4);
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  color: var(--text-primary);
  font-size: var(--text-sm);
  font-family: var(--font-sans);
  resize: none;
  max-height: 120px;
  overflow-y: auto;
  transition: all var(--transition-fast);
}

.chat-input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(226, 251, 82, 0.1);
  background: var(--bg-tertiary);
}

.chat-input::placeholder {
  color: var(--text-tertiary);
}

.chat-send-btn {
  width: 44px;
  height: 44px;
  background: var(--brand);
  color: var(--text-inverse);
  border: none;
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-base);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.chat-send-btn:hover {
  background: var(--brand-hover);
  box-shadow: 0 0 20px rgba(226, 251, 82, 0.4);
  transform: scale(1.05);
}

.chat-send-btn:active {
  transform: scale(0.95);
}

.chat-send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

@media (max-width: 768px) {
  .chat-messages {
    max-height: 400px;
  }
  
  .message-content {
    max-width: 85%;
  }
  
  .chat-input-wrapper {
    gap: var(--space-2);
  }
  
  .chat-send-btn {
    width: 40px;
    height: 40px;
  }
}
</style>

<!-- Deliver Modal -->
<div id="deliverModal" class="delivery-modal">
  <div class="modal-backdrop" onclick="closeDeliverModal()"></div>
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-header-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
      </div>
      <div class="modal-header-text">
        <h2 class="modal-title">Deliver Order #{{ order.id }}</h2>
        <p class="modal-subtitle">Upload files and complete the delivery</p>
      </div>
      <button onclick="closeDeliverModal()" class="modal-close" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <form action="/order/{{ order.id }}/deliver" method="post" enctype="multipart/form-data" id="deliverForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="response_text" class="form-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Delivery Message
          </label>
          <textarea 
            id="response_text" 
            name="response_text" 
            class="form-textarea" 
            rows="5" 
            placeholder="Describe what you've delivered, any notes, or instructions for the customer..."
            required
          ></textarea>
          <span class="form-help">Be clear and professional in your delivery message</span>
        </div>
        
        <div class="form-group">
          <label for="files" class="form-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
            Upload Delivery Files
          </label>
          
          <div class="file-upload-area" id="fileUploadArea">
            <input 
              type="file" 
              id="files" 
              name="files" 
              class="file-input" 
              accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.zip,.rar,.wav,.mp3"
              multiple
              required
              onchange="handleFilesSelect(this)"
            >
            <label for="files" class="file-upload-label">
              <div class="file-upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </div>
              <div class="file-upload-text">
                <span class="file-upload-title">Click to upload or drag and drop</span>
                <span class="file-upload-subtitle">PDF, DOC, Images, Audio, ZIP (max 10MB per file)</span>
              </div>
            </label>
            <div class="files-selected" id="filesSelected" style="display: none;">
              <div class="files-list" id="filesList"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" onclick="closeDeliverModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-success" id="submitDeliveryBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          Deliver Order
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Audio Preview Modal -->
<div id="audioPreviewModal" class="audio-preview-modal">
  <div class="modal-backdrop" onclick="closeAudioPreview()"></div>
  <div class="audio-modal-panel">
    <div class="audio-modal-header">
      <div class="audio-modal-header-content">
        <button onclick="goToPreviousFile()" class="audio-nav-btn" id="prevBtn" title="Previous">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="audio-modal-title-info">
          <h3 class="audio-modal-title" id="audioModalTitle">Audio Preview</h3>
          <span class="audio-modal-subtitle" id="audioModalSubtitle"></span>
        </div>
        <button onclick="goToNextFile()" class="audio-nav-btn" id="nextBtn" title="Next">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
      <button onclick="closeAudioPreview()" class="audio-modal-close" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <a href="#" id="audioDownloadLink" class="audio-download-btn" download title="Download">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </a>
    </div>
    
    <div class="audio-modal-body">
      <div class="audio-player-container">
        <canvas id="audioWaveform" class="audio-waveform"></canvas>
        <div class="audio-controls">
          <div class="audio-time-display">
            <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
          </div>
          <div class="audio-control-buttons">
            <button onclick="rewindAudio()" class="audio-control-btn" title="Rewind 5s">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="11 19 2 12 11 5 11 19"></polygon>
                <polygon points="22 19 13 12 22 5 22 19"></polygon>
              </svg>
            </button>
            <button onclick="toggleAudioPlay()" class="audio-play-btn" id="audioPlayBtn" title="Play/Pause">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="playIcon">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="pauseIcon" style="display: none;">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
              </svg>
            </button>
            <button onclick="forwardAudio()" class="audio-control-btn" title="Forward 5s">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                <polygon points="2 19 11 12 2 5 2 19"></polygon>
              </svg>
            </button>
          </div>
        </div>
        <audio id="audioPlayer" preload="metadata"></audio>
      </div>
      <div class="audio-file-list" id="audioFileList"></div>
    </div>
  </div>
</div>

<style>
/* Enhanced Delivery Modal */
.delivery-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: var(--z-modal);
  align-items: center;
  justify-content: center;
  padding: var(--space-6);
}

.delivery-modal.is-open {
  display: flex;
}

.modal-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(10, 14, 23, 0.85);
  backdrop-filter: blur(8px);
  animation: fadeIn 0.2s ease-out;
}

.modal-panel {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-2xl);
  max-width: 650px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-2xl);
  animation: slideUp 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  display: flex;
  align-items: flex-start;
  gap: var(--space-4);
  padding: var(--space-8);
  border-bottom: 1px solid var(--border-subtle);
}

.modal-header-icon {
  width: 48px;
  height: 48px;
  background: var(--brand-subtle);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
  flex-shrink: 0;
}

.modal-header-text {
  flex: 1;
}

.modal-title {
  font-size: var(--text-2xl);
  font-weight: 900;
  margin-bottom: var(--space-1);
  color: var(--text-primary);
}

.modal-subtitle {
  font-size: var(--text-sm);
  color: var(--text-secondary);
}

.modal-close {
  width: 36px;
  height: 36px;
  background: transparent;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
  flex-shrink: 0;
}

.modal-close:hover {
  background: var(--surface-hover);
  border-color: var(--border-strong);
  color: var(--text-primary);
}

.modal-body {
  padding: var(--space-8);
}

.modal-footer {
  display: flex;
  gap: var(--space-4);
  justify-content: flex-end;
  padding: var(--space-6) var(--space-8);
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-secondary);
}

/* File Upload Area */
.file-upload-area {
  position: relative;
}

.file-input {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.file-upload-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-8);
  background: var(--bg-secondary);
  border: 2px dashed var(--border-default);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all var(--transition-base);
}

.file-upload-label:hover {
  border-color: var(--brand);
  background: var(--bg-tertiary);
}

.file-upload-icon {
  color: var(--text-tertiary);
  transition: all var(--transition-base);
}

.file-upload-label:hover .file-upload-icon {
  color: var(--brand);
  transform: translateY(-4px);
}

.file-upload-text {
  text-align: center;
}

.file-upload-title {
  display: block;
  font-size: var(--text-base);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.file-upload-subtitle {
  display: block;
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.file-selected {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4);
  background: var(--success-bg);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: var(--radius-lg);
}

.file-selected-icon {
  width: 40px;
  height: 40px;
  background: var(--success);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

.file-selected-info {
  flex: 1;
  min-width: 0;
}

.file-selected-name {
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: var(--space-1);
}

.file-selected-size {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.file-remove-btn {
  width: 32px;
  height: 32px;
  background: transparent;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.file-remove-btn:hover {
  background: var(--error-bg);
  border-color: var(--error);
  color: var(--error);
}

@media (max-width: 768px) {
  .modal-panel {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .modal-header {
    padding: var(--space-6);
  }
  
  .modal-body {
    padding: var(--space-6);
  }
  
  .modal-footer {
    padding: var(--space-4) var(--space-6);
    flex-direction: column;
  }
  
  .modal-footer .btn {
    width: 100%;
  }
}

/* Files Selected List */
.files-selected {
  margin-top: var(--space-4);
}

.files-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.files-list .file-selected {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

/* Attachment Actions */
.attachment-actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.preview-btn {
  padding: var(--space-2) var(--space-4);
  background: var(--brand);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  font-size: var(--text-sm);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.preview-btn:hover {
  background: var(--brand-hover);
  transform: translateY(-1px);
}

/* Audio Preview Modal */
.audio-preview-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
}

.audio-preview-modal.is-open {
  display: flex;
  align-items: center;
  justify-content: center;
}

.audio-modal-panel {
  position: relative;
  background: var(--surface);
  border-radius: var(--radius-xl);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  z-index: 10001;
  overflow: hidden;
}

.audio-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-5);
  border-bottom: 1px solid var(--border-default);
  gap: var(--space-4);
}

.audio-modal-header-content {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  flex: 1;
  min-width: 0;
}

.audio-nav-btn {
  width: 36px;
  height: 36px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.audio-nav-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-strong);
}

.audio-modal-title-info {
  flex: 1;
  min-width: 0;
  text-align: center;
}

.audio-modal-title {
  font-size: var(--text-lg);
  font-weight: 700;
  color: var(--text-primary);
  margin: 0 0 var(--space-1) 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.audio-modal-subtitle {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
}

.audio-modal-close,
.audio-download-btn {
  width: 36px;
  height: 36px;
  background: transparent;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  text-decoration: none;
}

.audio-modal-close:hover {
  background: var(--error-bg);
  border-color: var(--error);
  color: var(--error);
}

.audio-download-btn:hover {
  background: var(--success-bg);
  border-color: var(--success);
  color: var(--success);
}

.audio-modal-body {
  padding: var(--space-6);
  overflow-y: auto;
  flex: 1;
}

.audio-player-container {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  margin-bottom: var(--space-6);
}

.audio-waveform {
  width: 100%;
  height: 200px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-4);
  display: block;
}

.audio-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
}

.audio-time-display {
  font-size: var(--text-sm);
  font-weight: 600;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

.audio-control-buttons {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.audio-control-btn,
.audio-play-btn {
  width: 44px;
  height: 44px;
  background: var(--brand);
  border: none;
  border-radius: var(--radius-full);
  color: white;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.audio-play-btn {
  width: 56px;
  height: 56px;
}

.audio-control-btn:hover,
.audio-play-btn:hover {
  background: var(--brand-hover);
  transform: scale(1.05);
}

.audio-control-btn:active,
.audio-play-btn:active {
  transform: scale(0.95);
}

.audio-file-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: var(--space-3);
}

@media (max-width: 768px) {
  .audio-modal-panel {
    width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .audio-modal-header {
    padding: var(--space-4);
  }
  
  .audio-modal-body {
    padding: var(--space-4);
  }
  
  .audio-waveform {
    height: 150px;
  }
  
  .audio-controls {
    flex-direction: column;
    gap: var(--space-3);
  }
}
</style>

<script>
function openDeliverModal() {
  document.getElementById('deliverModal').classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeDeliverModal() {
  document.getElementById('deliverModal').classList.remove('is-open');
  document.body.style.overflow = '';
  document.getElementById('deliverForm').reset();
  document.getElementById('fileUploadArea').querySelector('.file-upload-label').style.display = 'flex';
  document.getElementById('filesSelected').style.display = 'none';
  document.getElementById('filesList').innerHTML = '';
}

function handleFilesSelect(input) {
  if (input.files && input.files.length > 0) {
    const fileLabel = document.getElementById('fileUploadArea').querySelector('.file-upload-label');
    const filesSelected = document.getElementById('filesSelected');
    const filesList = document.getElementById('filesList');
    
    // Hide upload label, show selected files
    fileLabel.style.display = 'none';
    filesSelected.style.display = 'block';
    filesList.innerHTML = '';
    
    // Display all selected files
    Array.from(input.files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-selected';
      fileItem.innerHTML = `
        <div class="file-selected-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
          </svg>
        </div>
        <div class="file-selected-info">
          <div class="file-selected-name">${file.name}</div>
          <div class="file-selected-size">${formatFileSize(file.size)}</div>
        </div>
        <button type="button" onclick="removeFile(${index})" class="file-remove-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `;
      filesList.appendChild(fileItem);
    });
  }
}

function removeFile(index) {
  const fileInput = document.getElementById('files');
  const dt = new DataTransfer();
  Array.from(fileInput.files).forEach((file, i) => {
    if (i !== index) dt.items.add(file);
  });
  fileInput.files = dt.files;
  handleFilesSelect(fileInput);
}

let audioFiles = [];
let currentAudioIndex = 0;
let audioContext = null;
let audioAnalyser = null;
let animationFrame = null;

function openAudioPreview(audioUrl, filename) {
  // Collect all audio files from the current delivery
  const deliverySection = event.target.closest('.timeline-item');
  const attachments = deliverySection.querySelectorAll('.attachment-item');
  audioFiles = [];
  
  attachments.forEach(item => {
    const previewBtn = item.querySelector('.preview-btn');
    if (previewBtn) {
      const onclick = previewBtn.getAttribute('onclick');
      const match = onclick.match(/openAudioPreview\('([^']+)',\s*'([^']+)'\)/);
      if (match) {
        audioFiles.push({
          url: match[1],
          filename: match[2]
        });
      }
    }
  });
  
  // Find current file index
  currentAudioIndex = audioFiles.findIndex(f => f.url === audioUrl);
  if (currentAudioIndex === -1) currentAudioIndex = 0;
  
  // Update navigation buttons
  document.getElementById('prevBtn').style.display = audioFiles.length > 1 ? 'flex' : 'none';
  document.getElementById('nextBtn').style.display = audioFiles.length > 1 ? 'flex' : 'none';
  
  // Load audio
  loadAudio(audioUrl, filename);
  
  // Show modal
  document.getElementById('audioPreviewModal').classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeAudioPreview() {
  const audio = document.getElementById('audioPlayer');
  audio.pause();
  audio.src = '';
  if (animationFrame) {
    cancelAnimationFrame(animationFrame);
    animationFrame = null;
  }
  if (audioContext) {
    audioContext.close();
    audioContext = null;
  }
  document.getElementById('audioPreviewModal').classList.remove('is-open');
  document.body.style.overflow = '';
}

function loadAudio(url, filename) {
  const audio = document.getElementById('audioPlayer');
  const downloadLink = document.getElementById('audioDownloadLink');
  
  audio.src = url;
  downloadLink.href = url;
  downloadLink.download = filename;
  document.getElementById('audioModalTitle').textContent = filename;
  document.getElementById('audioModalSubtitle').textContent = '';
  
  audio.addEventListener('loadedmetadata', () => {
    document.getElementById('totalTime').textContent = formatTime(audio.duration);
  });
  
  audio.addEventListener('timeupdate', () => {
    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
    drawWaveform();
  });
  
  audio.addEventListener('play', () => {
    document.getElementById('playIcon').style.display = 'none';
    document.getElementById('pauseIcon').style.display = 'block';
    startWaveformAnimation();
  });
  
  audio.addEventListener('pause', () => {
    document.getElementById('playIcon').style.display = 'block';
    document.getElementById('pauseIcon').style.display = 'none';
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }
  });
  
  audio.addEventListener('ended', () => {
    document.getElementById('playIcon').style.display = 'block';
    document.getElementById('pauseIcon').style.display = 'none';
  });
}

function toggleAudioPlay() {
  const audio = document.getElementById('audioPlayer');
  if (audio.paused) {
    audio.play();
  } else {
    audio.pause();
  }
}

function rewindAudio() {
  const audio = document.getElementById('audioPlayer');
  audio.currentTime = Math.max(0, audio.currentTime - 5);
}

function forwardAudio() {
  const audio = document.getElementById('audioPlayer');
  audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
}

function goToPreviousFile() {
  if (audioFiles.length === 0) return;
  currentAudioIndex = (currentAudioIndex - 1 + audioFiles.length) % audioFiles.length;
  const file = audioFiles[currentAudioIndex];
  loadAudio(file.url, file.filename);
}

function goToNextFile() {
  if (audioFiles.length === 0) return;
  currentAudioIndex = (currentAudioIndex + 1) % audioFiles.length;
  const file = audioFiles[currentAudioIndex];
  loadAudio(file.url, file.filename);
}

function formatTime(seconds) {
  if (!isFinite(seconds)) return '00:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function startWaveformAnimation() {
  const canvas = document.getElementById('audioWaveform');
  const ctx = canvas.getContext('2d');
  const audio = document.getElementById('audioPlayer');
  
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    audioAnalyser = audioContext.createAnalyser();
    audioAnalyser.fftSize = 256;
    const source = audioContext.createMediaElementSource(audio);
    source.connect(audioAnalyser);
    audioAnalyser.connect(audioContext.destination);
  }
  
  function animate() {
    if (audio.paused) return;
    
    const bufferLength = audioAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    audioAnalyser.getByteFrequencyData(dataArray);
    
    drawWaveform(dataArray);
    animationFrame = requestAnimationFrame(animate);
  }
  
  animate();
}

function drawWaveform(dataArray) {
  const canvas = document.getElementById('audioWaveform');
  const ctx = canvas.getContext('2d');
  const audio = document.getElementById('audioPlayer');
  
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  ctx.fillStyle = 'rgba(30, 30, 30, 1)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  if (!dataArray || dataArray.length === 0) {
    // Static waveform when no data
    ctx.strokeStyle = '#10b981';
    ctx.lineWidth = 2;
    ctx.beginPath();
    const centerY = canvas.height / 2;
    for (let x = 0; x < canvas.width; x += 4) {
      const progress = audio.currentTime / audio.duration;
      const waveformX = progress * canvas.width;
      const amplitude = Math.sin((x / canvas.width) * Math.PI * 8) * 30;
      ctx.lineTo(x, centerY + (x < waveformX ? amplitude : 0));
    }
    ctx.stroke();
    return;
  }
  
  const barWidth = canvas.width / dataArray.length;
  ctx.fillStyle = '#10b981';
  
  for (let i = 0; i < dataArray.length; i++) {
    const barHeight = (dataArray[i] / 255) * canvas.height;
    const x = i * barWidth;
    ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('deliverModal').classList.contains('is-open')) {
    closeDeliverModal();
  }
});

// Form submission with loading state
document.getElementById('deliverForm').addEventListener('submit', function(e) {
  const submitBtn = document.getElementById('submitDeliveryBtn');
  const originalHTML = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
  
  // Re-enable after 10 seconds in case of error
  setTimeout(() => {
    if (submitBtn.disabled) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalHTML;
    }
  }, 10000);
});

// ============================================
// CHAT FUNCTIONALITY
// ============================================

// Auto-resize textarea
const messageInput = document.getElementById('messageInput');
if (messageInput) {
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
  
  // Send message with Enter (Shift+Enter for new line)
  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (this.value.trim()) {
        sendMessage();
      }
    }
  });
}

// Scroll to bottom of chat
function scrollToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
}

// ============================================
// CHAT SIDEBAR TOGGLE
// ============================================
function toggleChatSidebar() {
  const chatSidebar = document.getElementById('chatSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (chatSidebar.classList.contains('open')) {
    chatSidebar.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  } else {
    chatSidebar.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    scrollToBottom();
    
    // Focus on input after sidebar opens
    setTimeout(() => {
      const messageInput = document.getElementById('messageInput');
      if (messageInput) messageInput.focus();
    }, 300);
  }
}

// Close sidebar on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const chatSidebar = document.getElementById('chatSidebar');
    if (chatSidebar && chatSidebar.classList.contains('open')) {
      toggleChatSidebar();
    }
  }
});

// ============================================
// COUNTDOWN TIMER
// ============================================
{% if order.status != 'Completed' and order.status != 'Cancelled' and order.due_date %}
function updateCountdown() {
  const dueDate = new Date('{{ order.due_date.isoformat() if order.due_date else "" }}');
  const now = new Date();
  const diff = dueDate - now;
  
  const daysEl = document.getElementById('days');
  const hoursEl = document.getElementById('hours');
  const minutesEl = document.getElementById('minutes');
  const secondsEl = document.getElementById('seconds');
  
  if (!daysEl || !hoursEl || !minutesEl || !secondsEl) {
    return;
  }
  
  if (diff <= 0) {
    daysEl.textContent = '00';
    hoursEl.textContent = '00';
    minutesEl.textContent = '00';
    secondsEl.textContent = '00';
    return;
  }
  
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  daysEl.textContent = String(days).padStart(2, '0');
  hoursEl.textContent = String(hours).padStart(2, '0');
  minutesEl.textContent = String(minutes).padStart(2, '0');
  secondsEl.textContent = String(seconds).padStart(2, '0');
}

// Update countdown every second
document.addEventListener('DOMContentLoaded', function() {
  {% if order.status != 'Completed' and order.status != 'Cancelled' and order.due_date %}
  updateCountdown(); // Initial update
  setInterval(updateCountdown, 1000);
  {% endif %}
  
  scrollToBottom();
  
  // If URL has #chat, open chat sidebar
  if (window.location.hash === '#chat') {
    setTimeout(() => {
      toggleChatSidebar();
    }, 100);
  }
});
{% else %}
// Scroll on page load
document.addEventListener('DOMContentLoaded', function() {
  scrollToBottom();
  
  // If URL has #chat, open chat sidebar
  if (window.location.hash === '#chat') {
    setTimeout(() => {
      toggleChatSidebar();
    }, 100);
  }
});
{% endif %}

// Auto-refresh messages every 5 seconds
let lastMessageCount = {{ messages|length }};

async function refreshMessages() {
  try {
    const response = await fetch('/order/{{ order.id }}/messages');
    const data = await response.json();
    const messages = data.messages;
    
    // Only update if new messages
    if (messages.length !== lastMessageCount) {
      lastMessageCount = messages.length;
      updateChatUI(messages);
      scrollToBottom();
    }
  } catch (error) {
    console.error('Error refreshing messages:', error);
  }
}

function updateChatUI(messages) {
  const chatMessages = document.getElementById('chatMessages');
  const currentUserId = {{ request.session.get('user_id') }};
  
  if (messages.length === 0) {
    chatMessages.innerHTML = `
      <div class="chat-empty">
        <div class="chat-empty-icon">üí¨</div>
        <p class="chat-empty-text">No messages yet. Start the conversation!</p>
      </div>
    `;
    return;
  }
  
  chatMessages.innerHTML = messages.map(msg => {
    const isSent = msg.sender_id === currentUserId;
    const avatarHTML = msg.sender_avatar 
      ? `<img src="/uploads/${msg.sender_avatar}" alt="${msg.sender_name}">`
      : `<div class="avatar-placeholder">${msg.sender_name[0].toUpperCase()}</div>`;
    
    return `
      <div class="message ${isSent ? 'message-sent' : 'message-received'}">
        <div class="message-avatar">${avatarHTML}</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-author">${msg.sender_name}</span>
            <span class="message-time">${msg.created_at}</span>
          </div>
          <div class="message-bubble">
            <p class="message-text">${escapeHtml(msg.message_text)}</p>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add message directly to UI without refreshing
function addMessageToUI(messageData) {
  const chatMessages = document.getElementById('chatMessages');
  if (!chatMessages) return;
  
  // Remove empty state if it exists
  const emptyState = chatMessages.querySelector('.chat-empty');
  if (emptyState) {
    emptyState.remove();
  }
  
  // Get current user ID
  const currentUserId = {{ request.session.get('user_id') }};
  const isSent = messageData.sender_id === currentUserId;
  
  // Create message HTML
  const avatarHTML = messageData.sender_avatar 
    ? `<img src="/uploads/${messageData.sender_avatar}" alt="${messageData.sender_name}">`
    : `<div class="avatar-placeholder">${messageData.sender_name[0].toUpperCase()}</div>`;
  
  const messageHTML = `
    <div class="message message-new ${isSent ? 'message-sent' : 'message-received'}">
      <div class="message-avatar">${avatarHTML}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${messageData.sender_name}</span>
          <span class="message-time">${messageData.created_at || 'Just now'}</span>
        </div>
        <div class="message-bubble">
          <p class="message-text">${escapeHtml(messageData.message_text)}</p>
        </div>
      </div>
    </div>
  `;
  
  // Append to messages container
  chatMessages.insertAdjacentHTML('beforeend', messageHTML);
  
  // Get the newly added message element
  const newMessage = chatMessages.lastElementChild;
  
  // Smooth scroll to new message
  if (newMessage) {
    newMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
    
    // Remove animation class after animation completes (prevents re-animation on refresh)
    setTimeout(() => {
      if (newMessage && newMessage.classList.contains('message-new')) {
        newMessage.classList.remove('message-new');
      }
    }, 300);
  }
}

// Refresh every 5 seconds
setInterval(refreshMessages, 5000);

// Submit handler for chat form
// ============================================
// SEND MESSAGE (AJAX)
// ============================================
async function sendMessage() {
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  
  if (!messageInput || !messageInput.value.trim()) {
    return;
  }
  
  const messageText = messageInput.value.trim();
  
  // Disable button and input to prevent duplicate sends
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.6';
    sendBtn.style.cursor = 'not-allowed';
  }
  if (messageInput) {
    messageInput.disabled = true;
  }
  
  try {
    // Send message via AJAX
    const formData = new FormData();
    formData.append('message_text', messageText);
    
    const response = await fetch(`/order/{{ order.id }}/messages/send`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
      },
      body: formData
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ detail: 'Failed to send message' }));
      throw new Error(errorData.detail || 'Failed to send message');
    }
    
    const data = await response.json();
    
    if (data.success && data.message) {
      // Clear input immediately for better UX
      messageInput.value = '';
      messageInput.style.height = 'auto';
      
      // Add message directly to UI without refreshing
      addMessageToUI(data.message);
      
      // Update last message count
      lastMessageCount++;
      
      // Scroll to bottom
      setTimeout(() => {
        scrollToBottom();
      }, 50);
    }
  } catch (error) {
    console.error('Error sending message:', error);
    // Restore message text on error so user doesn't lose it
    messageInput.value = messageText;
  } finally {
    // Re-enable button and input
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.style.opacity = '1';
      sendBtn.style.cursor = 'pointer';
    }
    if (messageInput) {
      messageInput.disabled = false;
      messageInput.focus();
    }
  }
}

// Form submission handler (prevent default form submission)
const chatForm = document.getElementById('chatForm');
if (chatForm) {
  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
  });
}
</script>
{% endblock %}

